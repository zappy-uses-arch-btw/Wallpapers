#!/bin/bash
#  ╔══════════════════════════════════════════════════════════════════╗
#  ║                     CWAL - Change Wallpaper                      ║
#  ╚══════════════════════════════════════════════════════════════════╝
#  Usage: cwal /path/to/wallpaper.png

set -e

# ─────────────────────────────────────────────────────────────────────
# Check Arguments
# ─────────────────────────────────────────────────────────────────────

if [ -z "$1" ]; then
    echo "Usage: cwal /path/to/wallpaper.png"
    exit 1
fi

WALLPAPER="$1"

if [ ! -f "$WALLPAPER" ]; then
    echo "Error: File not found: $WALLPAPER"
    exit 1
fi

# ─────────────────────────────────────────────────────────────────────
# Set Wallpaper
# ─────────────────────────────────────────────────────────────────────

echo "Setting wallpaper: $WALLPAPER"
feh --bg-fill "$WALLPAPER"

# Save current wallpaper path
echo "$WALLPAPER" > ~/.cache/current_wallpaper

# ─────────────────────────────────────────────────────────────────────
# Generate Colors with Wallust
# ─────────────────────────────────────────────────────────────────────

echo "Generating colors with wallust..."
wallust run "$WALLPAPER"

# ─────────────────────────────────────────────────────────────────────
# Reload Applications
# ─────────────────────────────────────────────────────────────────────

# Reload bspwm settings directly instead of full restart to prevent crash
if [ -f "$HOME/.config/bspwm/colors.sh" ]; then
    . "$HOME/.config/bspwm/colors.sh"
    bspc config normal_border_color   "$color0"
    bspc config active_border_color   "$color8"
    bspc config focused_border_color  "$color4"
    bspc config presel_feedback_color "$color1"
fi

echo "Reloading polybar..."
~/.config/polybar/launch.sh &

echo "Reloading dunst..."
killall dunst 2>/dev/null || true
dunst &

# ─────────────────────────────────────────────────────────────────────
# Notify User
# ─────────────────────────────────────────────────────────────────────

notify-send "Wallpaper Changed" "$(basename "$WALLPAPER")" -i "$WALLPAPER"

echo "Done!"
